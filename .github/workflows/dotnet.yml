name: .NET CI/CD

on:
  push:
    branches: [main]
    paths:
      - "RegMan.Backend.API/**"
      - "RegMan.Backend.BusinessLayer/**"
      - "RegMan.Backend.DAL/**"
      - ".github/workflows/dotnet.yml"
  pull_request:
    branches: [main]
    paths:
      - "RegMan.Backend.API/**"
      - "RegMan.Backend.BusinessLayer/**"
      - "RegMan.Backend.DAL/**"
      - ".github/workflows/dotnet.yml"

concurrency:
  group: backend-dotnet-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  security-events: write

env:
  DOTNET_VERSION: "8.0.x"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
  Jwt__Key: ${{ secrets.JWT_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL (C#)
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.fsproj', '**/*.props', '**/*.targets', '**/NuGet.Config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore dependencies
        run: dotnet restore RegMan.Backend.API/RegMan.Backend.API.csproj

      - name: Build
        run: dotnet build RegMan.Backend.API/RegMan.Backend.API.csproj --configuration Release --no-restore

      - name: Perform CodeQL Analysis
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"

      - name: Setup Python (Semgrep)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep

      - name: Run Semgrep (p/ci)
        run: semgrep --config p/ci --json --metrics=off --exclude node_modules --exclude bin --exclude obj RegMan.Backend.API RegMan.Backend.BusinessLayer RegMan.Backend.DAL > semgrep.json

      - name: Fail on High/Critical (Semgrep ERROR)
        run: |
          python - <<'PY'
          import json
          import sys

          with open('semgrep.json', 'r', encoding='utf-8') as f:
            data = json.load(f)

          results = data.get('results', []) or []
          errors = [
            r for r in results
            if (r.get('extra', {}).get('severity') or '').upper() == 'ERROR'
          ]

          print(f"Semgrep findings: {len(results)} total, {len(errors)} ERROR")
          if errors:
            for r in errors[:20]:
              msg = (r.get('extra', {}).get('message') or r.get('check_id') or 'Semgrep finding')
              path = r.get('path')
              start = (r.get('start') or {}).get('line')
              end = (r.get('end') or {}).get('line')
              print(f"- {path}:{start}-{end}: {msg}")
            sys.exit(1)
          PY

      - name: Publish
        run: dotnet publish RegMan.Backend.API/RegMan.Backend.API.csproj --configuration Release --output ./publish --no-build --no-restore

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-package
          path: ./publish
